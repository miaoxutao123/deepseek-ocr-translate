import{q as R,r as z,i as I,s as ve,v as ye,c as _,o as d,b as l,w as s,d as u,E as V,x as be,h as r,y as ke,g as o,k as m,l as J,z as he,t as i,m as v,A as w,B as Ce,F as Z,n as K,C as xe}from"./index-BEEL7eZv.js";import{_ as Se}from"./_plugin-vue_export-helper-DlAUqK2U.js";const O={getList(g){return R.get("/history",{params:g})},getDetail(g){return R.get(`/history/${g}`)},delete(g){return R.delete(`/history/${g}`)},export(g,h="markdown"){return R.get(`/history/${g}/export`,{params:{format:h},responseType:"blob"})}},ze={class:"history-container"},Te={class:"header"},Ne={class:"filters"},Re={class:"filename"},Ve={class:"status-cell"},De={key:0,style:{"font-size":"11px",color:"#999","margin-top":"4px"}},Pe={key:1,class:"progress-info"},$e={class:"progress-message"},Ie={key:0},Oe={key:1,class:"result-section"},Be={class:"page-result"},Ee={class:"result-text"},Ae={key:2,class:"result-section"},Fe={key:0},Ue={class:"translation-result"},He={class:"original"},Le={class:"translated"},Me={class:"task-info"},Ge={__name:"History",setup(g){const h=z(!1),D=z([]),p=z({page:1,pageSize:20,total:0}),f=z({taskType:"",status:""}),n=z({visible:!1,title:"",data:null});let y=null;const Q=I(()=>{let a=D.value;return f.value.status&&(a=a.filter(e=>e.status===f.value.status)),a}),B=I(()=>{if(!n.value.data?.ocr_result)return[];try{return JSON.parse(n.value.data.ocr_result)}catch(a){return console.error("Failed to parse OCR result:",a),[]}}),E=I(()=>{if(!n.value.data?.translation_result)return[];try{return JSON.parse(n.value.data.translation_result)}catch(a){return console.error("Failed to parse translation result:",a),[]}}),b=async()=>{h.value=!0;try{const a={page:p.value.page,page_size:p.value.pageSize};f.value.taskType&&(a.task_type=f.value.taskType);const e=await O.getList(a);D.value=e.items,p.value.total=e.total;const S=D.value.some(C=>C.status==="pending"||C.status==="processing");S&&!y?le():!S&&y&&F()}catch(a){V.error("加载历史记录失败: "+(a.message||"未知错误"))}finally{h.value=!1}},W=()=>{b()},A=()=>{p.value.page=1,b()},X=a=>{p.value.page=a,b()},Y=a=>{p.value.pageSize=a,p.value.page=1,b()},ee=a=>{(a.status==="completed"||a.status==="failed")&&P(a)},P=async a=>{try{const e=await O.getDetail(a.id);n.value={visible:!0,title:`${$(e.task_type)} - ${e.original_filename}`,data:e}}catch(e){V.error("加载详情失败: "+(e.message||"未知错误"))}},te=()=>{n.value={visible:!1,title:"",data:null}},ae=async a=>{try{await xe.confirm(`确定要删除 "${a.original_filename}" 吗？`,"确认删除",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning"}),await O.delete(a.id),V.success("删除成功"),b()}catch(e){e!=="cancel"&&V.error("删除失败: "+(e.message||"未知错误"))}},le=()=>{y||(y=setInterval(()=>{b()},3e3))},F=()=>{y&&(clearInterval(y),y=null)},$=a=>({ocr:"OCR识别",translate:"翻译",correct:"校正"})[a]||a,se=a=>({ocr:"primary",translate:"success",correct:"warning"})[a]||"info",U=a=>({pending:"等待中",processing:"处理中",completed:"已完成",failed:"失败"})[a]||a,H=a=>({pending:"info",processing:"warning",completed:"success",failed:"danger"})[a]||"info",ne=({row:a})=>a.status==="processing"?"processing-row":a.status==="failed"?"failed-row":"",L=a=>!a.total_pages||a.total_pages===0?0:Math.round((a.current_page||0)/a.total_pages*100),oe=a=>{const e=L(a);return e<30?"#909399":e<70?"#E6A23C":"#67C23A"},T=a=>{if(!a)return"-";const e=new Date(a);return isNaN(e.getTime())?"-":e.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1,timeZone:"Asia/Shanghai"})};return ve(()=>{b()}),ye(()=>{F()}),(a,e)=>{const S=u("el-icon"),C=u("el-button"),c=u("el-radio-button"),M=u("el-radio-group"),k=u("el-table-column"),N=u("el-tag"),G=u("el-progress"),re=u("el-table"),ie=u("el-pagination"),ue=u("el-card"),de=u("el-alert"),j=u("el-tab-pane"),q=u("el-tabs"),pe=u("el-empty"),ce=u("el-divider"),x=u("el-descriptions-item"),_e=u("el-descriptions"),ge=u("el-dialog"),fe=be("loading");return d(),_("div",ze,[l(ue,null,{header:s(()=>[r("div",Te,[e[6]||(e[6]=r("h2",null,"历史记录",-1)),l(C,{onClick:W,loading:h.value},{default:s(()=>[l(S,null,{default:s(()=>[l(J(Ce))]),_:1}),e[5]||(e[5]=o(" 刷新 ",-1))]),_:1},8,["loading"])])]),default:s(()=>[r("div",Ne,[l(M,{modelValue:f.value.taskType,"onUpdate:modelValue":e[0]||(e[0]=t=>f.value.taskType=t),onChange:A},{default:s(()=>[l(c,{label:""},{default:s(()=>[...e[7]||(e[7]=[o("全部",-1)])]),_:1}),l(c,{label:"ocr"},{default:s(()=>[...e[8]||(e[8]=[o("OCR识别",-1)])]),_:1}),l(c,{label:"translate"},{default:s(()=>[...e[9]||(e[9]=[o("翻译",-1)])]),_:1}),l(c,{label:"correct"},{default:s(()=>[...e[10]||(e[10]=[o("校正",-1)])]),_:1})]),_:1},8,["modelValue"]),l(M,{modelValue:f.value.status,"onUpdate:modelValue":e[1]||(e[1]=t=>f.value.status=t),onChange:A,style:{"margin-left":"20px"}},{default:s(()=>[l(c,{label:""},{default:s(()=>[...e[11]||(e[11]=[o("全部状态",-1)])]),_:1}),l(c,{label:"pending"},{default:s(()=>[...e[12]||(e[12]=[o("等待中",-1)])]),_:1}),l(c,{label:"processing"},{default:s(()=>[...e[13]||(e[13]=[o("处理中",-1)])]),_:1}),l(c,{label:"completed"},{default:s(()=>[...e[14]||(e[14]=[o("已完成",-1)])]),_:1}),l(c,{label:"failed"},{default:s(()=>[...e[15]||(e[15]=[o("失败",-1)])]),_:1})]),_:1},8,["modelValue"])]),ke((d(),m(re,{data:Q.value,style:{"margin-top":"20px"},onRowClick:ee,"row-class-name":ne},{default:s(()=>[l(k,{prop:"id",label:"ID",width:"80"}),l(k,{label:"文件名","min-width":"200"},{default:s(({row:t})=>[r("div",Re,[l(S,null,{default:s(()=>[l(J(he))]),_:1}),r("span",null,i(t.original_filename),1)])]),_:1}),l(k,{label:"任务类型",width:"100"},{default:s(({row:t})=>[l(N,{type:se(t.task_type)},{default:s(()=>[o(i($(t.task_type)),1)]),_:2},1032,["type"])]),_:1}),l(k,{label:"状态",width:"250"},{default:s(({row:t})=>[r("div",Ve,[l(N,{type:H(t.status)},{default:s(()=>[o(i(U(t.status)),1)]),_:2},1032,["type"]),t.status==="processing"||t.status==="PROCESSING"?(d(),_("div",De," Debug: "+i(t.current_page)+"/"+i(t.total_pages)+" ("+i(t.status)+") ",1)):v("",!0),(t.status==="processing"||t.status==="PROCESSING")&&t.total_pages&&t.total_pages>0?(d(),_("div",Pe,[l(G,{percentage:L(t),format:()=>`${t.current_page||0}/${t.total_pages}`,"stroke-width":8,color:oe(t)},null,8,["percentage","format","color"]),r("span",$e,i(t.progress_message),1)])):t.status==="processing"||t.status==="PROCESSING"?(d(),m(G,{key:2,percentage:100,indeterminate:!0,duration:3,style:{"margin-top":"5px",width:"100%"}})):v("",!0)])]),_:1}),l(k,{label:"创建时间",width:"180"},{default:s(({row:t})=>[o(i(T(t.created_at)),1)]),_:1}),l(k,{label:"完成时间",width:"180"},{default:s(({row:t})=>[o(i(t.completed_at?T(t.completed_at):"-"),1)]),_:1}),l(k,{label:"操作",width:"200",fixed:"right"},{default:s(({row:t})=>[l(C,{size:"small",onClick:w(me=>P(t),["stop"]),disabled:t.status!=="completed"},{default:s(()=>[...e[16]||(e[16]=[o(" 查看结果 ",-1)])]),_:1},8,["onClick","disabled"]),l(C,{size:"small",type:"danger",onClick:w(me=>ae(t),["stop"])},{default:s(()=>[...e[17]||(e[17]=[o(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[fe,h.value]]),l(ie,{"current-page":p.value.page,"onUpdate:currentPage":e[2]||(e[2]=t=>p.value.page=t),"page-size":p.value.pageSize,"onUpdate:pageSize":e[3]||(e[3]=t=>p.value.pageSize=t),"page-sizes":[10,20,50,100],total:p.value.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:Y,onCurrentChange:X,style:{"margin-top":"20px","justify-content":"center"}},null,8,["current-page","page-size","total"])]),_:1}),l(ge,{modelValue:n.value.visible,"onUpdate:modelValue":e[4]||(e[4]=t=>n.value.visible=t),title:n.value.title,width:"70%",onClose:te},{default:s(()=>[n.value.data?(d(),_("div",Ie,[n.value.data.status==="failed"&&n.value.data.error_message?(d(),m(de,{key:0,title:"处理失败",type:"error",description:n.value.data.error_message,closable:!1,style:{"margin-bottom":"20px"}},null,8,["description"])):v("",!0),n.value.data.ocr_result?(d(),_("div",Oe,[e[18]||(e[18]=r("h3",null,"OCR 识别结果",-1)),B.value.length>0?(d(),m(q,{key:0,type:"border-card"},{default:s(()=>[(d(!0),_(Z,null,K(B.value,t=>(d(),m(j,{key:t.page_number,label:`第 ${t.page_number} 页`},{default:s(()=>[r("div",Be,[t.confidence?(d(),m(N,{key:0,size:"small"},{default:s(()=>[o(" 置信度: "+i((t.confidence*100).toFixed(1))+"% ",1)]),_:2},1024)):v("",!0),r("pre",Ee,i(t.text),1)])]),_:2},1032,["label"]))),128))]),_:1})):(d(),m(pe,{key:1,description:"暂无识别结果"}))])):v("",!0),n.value.data.translation_result?(d(),_("div",Ae,[e[21]||(e[21]=r("h3",null,"翻译结果",-1)),E.value.length>0?(d(),_("div",Fe,[l(q,{type:"border-card"},{default:s(()=>[(d(!0),_(Z,null,K(E.value,t=>(d(),m(j,{key:t.page_number,label:`第 ${t.page_number} 页`},{default:s(()=>[r("div",Ue,[r("div",He,[e[19]||(e[19]=r("h4",null,"原文",-1)),r("pre",null,i(t.original_text),1)]),l(ce),r("div",Le,[e[20]||(e[20]=r("h4",null,"译文",-1)),r("pre",null,i(t.translated_text),1)])])]),_:2},1032,["label"]))),128))]),_:1})])):v("",!0)])):v("",!0),r("div",Me,[l(_e,{column:2,border:""},{default:s(()=>[l(x,{label:"任务ID"},{default:s(()=>[o(i(n.value.data.id),1)]),_:1}),l(x,{label:"任务类型"},{default:s(()=>[o(i($(n.value.data.task_type)),1)]),_:1}),l(x,{label:"状态"},{default:s(()=>[l(N,{type:H(n.value.data.status)},{default:s(()=>[o(i(U(n.value.data.status)),1)]),_:1},8,["type"])]),_:1}),l(x,{label:"文件名"},{default:s(()=>[o(i(n.value.data.original_filename),1)]),_:1}),l(x,{label:"创建时间"},{default:s(()=>[o(i(T(n.value.data.created_at)),1)]),_:1}),l(x,{label:"完成时间"},{default:s(()=>[o(i(n.value.data.completed_at?T(n.value.data.completed_at):"未完成"),1)]),_:1})]),_:1})])])):v("",!0)]),_:1},8,["modelValue","title"])])}}},Je=Se(Ge,[["__scopeId","data-v-cd23df68"]]);export{Je as default};
